<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</title>
    <!-- Tailwind CSS for modern UI -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js for data visualization -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- PapaParse for CSV parsing -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Pretendard:wght@400;600;700&display=swap');
        body { font-family: 'Pretendard', sans-serif; background-color: #f8fafc; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); }
        .loader { border-top-color: #3b82f6; animation: spinner 1.5s linear infinite; }
        @keyframes spinner { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Ranking highlights */
        .rank-1 { background-color: #fef3c7; border: 2px solid #fbbf24; } /* Gold */
        .rank-2 { background-color: #f1f5f9; border: 2px solid #cbd5e1; } /* Silver */
        .rank-3 { background-color: #ffedd5; border: 2px solid #fdba74; } /* Bronze */
    </style>
</head>
<body class="p-4 md:p-8">
    <div class="max-w-6xl mx-auto">
        <!-- Header -->
        <header class="mb-8 flex flex-col md:flex-row md:items-end justify-between gap-4">
            <div class="text-left">
                <h1 class="text-3xl font-bold text-gray-800 mb-2">ğŸ˜ï¸ ìš°ë¦¬ ë™ë„¤ ì•„íŒŒíŠ¸ ì‹¤ê±°ë˜ê°€ ëŒ€ì‹œë³´ë“œ</h1>
                <p class="text-gray-500">ì‹¤ì‹œê°„ CSV ë°ì´í„°ë¥¼ ê¸°ë°˜ìœ¼ë¡œ í•œ ë¶€ë™ì‚° íŠ¸ë Œë“œ ë¶„ì„</p>
            </div>
            <!-- Filter Section -->
            <div class="flex items-center gap-2">
                <label for="district-filter" class="text-sm font-semibold text-gray-700">ë™ë„¤ ì„ íƒ:</label>
                <select id="district-filter" class="bg-white border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block p-2.5 min-w-[150px]">
                    <option value="ì „ì²´">ì „ì²´ ë³´ê¸°</option>
                </select>
            </div>
        </header>

        <!-- Loading State -->
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loader ease-linear rounded-full border-4 border-t-4 border-gray-200 h-12 w-12 mb-4"></div>
            <p class="text-gray-600">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...</p>
        </div>

        <!-- Dashboard Content (Hidden until data loaded) -->
        <div id="content" class="hidden">
            <!-- Summary Stats -->
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-8">
                <div class="card p-6 border-l-4 border-blue-500">
                    <p class="text-sm text-gray-500 mb-1">ì „ì²´ ê±°ë˜ ê±´ìˆ˜</p>
                    <p id="stat-count" class="text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="card p-6 border-l-4 border-green-500">
                    <p class="text-sm text-gray-500 mb-1">í‰ê·  ê±°ë˜ê°€ (ë§Œì›)</p>
                    <p id="stat-avg" class="text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="card p-6 border-l-4 border-red-500">
                    <p class="text-sm text-gray-500 mb-1">ìµœê³  ê±°ë˜ê°€ (ë§Œì›)</p>
                    <p id="stat-max" class="text-2xl font-bold text-gray-800">-</p>
                </div>
                <div class="card p-6 border-l-4 border-yellow-500">
                    <p class="text-sm text-gray-500 mb-1">ìµœì € ê±°ë˜ê°€ (ë§Œì›)</p>
                    <p id="stat-min" class="text-2xl font-bold text-gray-800">-</p>
                </div>
            </div>

            <!-- Charts & Ranking Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-8 mb-8">
                <!-- Chart -->
                <div class="card p-6 lg:col-span-2">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ì›”ë³„ í‰ê·  ê±°ë˜ê°€ê²© ì¶”ì´</h2>
                    <div class="h-[350px]">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
                
                <!-- Ranking TOP 5 -->
                <div class="card p-6">
                    <h2 class="text-xl font-semibold mb-4 text-gray-700">ğŸ† ë¹„ì‹¼ ì•„íŒŒíŠ¸ TOP 5</h2>
                    <div id="ranking-list" class="space-y-3">
                        <!-- Ranking items injected by JS -->
                    </div>
                </div>
            </div>

            <!-- Table Section -->
            <div class="card overflow-hidden">
                <div class="p-6 border-b border-gray-100 flex justify-between items-center">
                    <h2 class="text-xl font-semibold text-gray-700">ìƒì„¸ ê±°ë˜ ë‚´ì—­</h2>
                    <span id="list-count-label" class="text-sm text-gray-400">0ê°œ í•­ëª©</span>
                </div>
                <div class="overflow-x-auto">
                    <table class="w-full text-left border-collapse">
                        <thead>
                            <tr class="bg-gray-50">
                                <th class="p-4 font-semibold text-gray-600 text-sm">ê±°ë˜ì¼ì</th>
                                <th class="p-4 font-semibold text-gray-600 text-sm">ì•„íŒŒíŠ¸ëª…</th>
                                <th class="p-4 font-semibold text-gray-600 text-sm">ë²•ì •ë™</th>
                                <th class="p-4 font-semibold text-gray-600 text-sm">ë©´ì (ã¡)</th>
                                <th class="p-4 font-semibold text-gray-600 text-sm">ì¸µ</th>
                                <th class="p-4 font-semibold text-gray-600 text-sm">ê¸ˆì•¡(ë§Œì›)</th>
                            </tr>
                        </thead>
                        <tbody id="table-body" class="text-sm text-gray-700">
                            <!-- Rows injected by JS -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Error Message -->
        <div id="error" class="hidden text-center py-20">
            <p class="text-red-500 font-semibold text-lg">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</p>
            <p class="text-gray-500 mt-2">URL ë˜ëŠ” ë°ì´í„° í˜•ì‹ì„ í™•ì¸í•´ ì£¼ì„¸ìš”.</p>
        </div>
    </div>

    <script>
        const CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSuzgquQ9j2JdsyGsX4wJtQQ7iiubGCqhfH2dkNZa6ouU6Uj6H3kPt0_X7ddgw1jRXrUZ51Fz0YbE6F/pub?gid=851889144&single=true&output=csv';
        
        let rawData = [];
        let priceChart = null;

        async function init() {
            try {
                const response = await fetch(CSV_URL);
                const csvText = await response.text();
                
                Papa.parse(csvText, {
                    header: true,
                    skipEmptyLines: true,
                    complete: function(results) {
                        rawData = results.data.map(item => ({
                            ...item,
                            price: parseInt(item["ê±°ë˜ê¸ˆì•¡(ë§Œì›)"].replace(/,/g, '')),
                            date: item["ê±°ë˜ì¼ì"],
                            district: item["ë²•ì •ë™"].trim(),
                            month: item["ê±°ë˜ì¼ì"].substring(0, 7) // YYYY-MM
                        }));
                        
                        setupFilter(rawData);
                        updateDashboard("ì „ì²´");
                    },
                    error: function(err) {
                        showError();
                    }
                });
            } catch (err) {
                showError();
            }
        }

        function setupFilter(data) {
            const filter = document.getElementById('district-filter');
            const districts = [...new Set(data.map(item => item.district))].sort();
            
            districts.forEach(d => {
                const option = document.createElement('option');
                option.value = d;
                option.textContent = d;
                filter.appendChild(option);
            });

            filter.addEventListener('change', (e) => {
                updateDashboard(e.target.value);
            });
        }

        function updateDashboard(selectedDistrict) {
            // Filter data based on selected district
            const filteredData = selectedDistrict === "ì „ì²´" 
                ? [...rawData] 
                : rawData.filter(item => item.district === selectedDistrict);

            // Sort by price descending
            filteredData.sort((a, b) => b.price - a.price);

            // 1. Summary Stats
            const prices = filteredData.map(d => d.price);
            const count = filteredData.length;
            const avg = count > 0 ? Math.round(prices.reduce((a, b) => a + b, 0) / count) : 0;
            const max = count > 0 ? Math.max(...prices) : 0;
            const min = count > 0 ? Math.min(...prices) : 0;

            document.getElementById('stat-count').innerText = count.toLocaleString() + 'ê±´';
            document.getElementById('stat-avg').innerText = avg.toLocaleString();
            document.getElementById('stat-max').innerText = max.toLocaleString();
            document.getElementById('stat-min').innerText = min.toLocaleString();
            document.getElementById('list-count-label').innerText = count.toLocaleString() + 'ê°œ í•­ëª©';

            // 2. Render Ranking TOP 5
            renderRanking(filteredData.slice(0, 5));

            // 3. Prepare Chart Data (Monthly Average)
            const monthlyPrices = {};
            filteredData.forEach(item => {
                if (!monthlyPrices[item.month]) {
                    monthlyPrices[item.month] = { sum: 0, count: 0 };
                }
                monthlyPrices[item.month].sum += item.price;
                monthlyPrices[item.month].count++;
            });

            const sortedMonths = Object.keys(monthlyPrices).sort();
            const avgMonthlyData = sortedMonths.map(m => Math.round(monthlyPrices[m].sum / monthlyPrices[m].count));

            renderChart(sortedMonths, avgMonthlyData);

            // 4. Render Table
            renderTable(filteredData);

            // Toggle visibility
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('content').classList.remove('hidden');
        }

        function renderRanking(topData) {
            const rankingList = document.getElementById('ranking-list');
            if (topData.length === 0) {
                rankingList.innerHTML = '<p class="text-center text-gray-400 py-10">ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>';
                return;
            }

            rankingList.innerHTML = topData.map((item, index) => {
                let rankClass = "";
                let medal = "";
                if (index === 0) { rankClass = "rank-1"; medal = "ğŸ¥‡"; }
                else if (index === 1) { rankClass = "rank-2"; medal = "ğŸ¥ˆ"; }
                else if (index === 2) { rankClass = "rank-3"; medal = "ğŸ¥‰"; }
                else { rankClass = "bg-gray-50 border border-gray-100"; medal = (index + 1); }

                return `
                    <div class="flex items-center p-3 rounded-lg ${rankClass} transition-transform hover:scale-[1.02]">
                        <div class="w-8 h-8 flex items-center justify-center font-bold text-lg mr-3">
                            ${medal}
                        </div>
                        <div class="flex-grow min-w-0">
                            <p class="font-bold text-gray-800 text-sm truncate" title="${item["ì•„íŒŒíŠ¸ëª…"]}">${item["ì•„íŒŒíŠ¸ëª…"]}</p>
                            <p class="text-xs text-gray-500">${item["ì „ìš©ë©´ì (ã¡)"]}ã¡ Â· ${item["ì¸µ"]}ì¸µ</p>
                        </div>
                        <div class="text-right ml-2">
                            <p class="font-bold text-blue-700">${item.price.toLocaleString()}</p>
                            <p class="text-[10px] text-gray-400">ë§Œì›</p>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('priceChart').getContext('2d');
            
            // Destroy existing chart to prevent overlap
            if (priceChart) {
                priceChart.destroy();
            }

            priceChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'ì›”ë³„ í‰ê·  ê±°ë˜ê¸ˆì•¡ (ë§Œì›)',
                        data: data,
                        borderColor: '#3b82f6',
                        backgroundColor: 'rgba(59, 130, 246, 0.1)',
                        borderWidth: 3,
                        fill: true,
                        tension: 0.4,
                        pointBackgroundColor: '#3b82f6',
                        pointRadius: 4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        y: {
                            beginAtZero: false,
                            grid: { color: '#f1f5f9' },
                            ticks: {
                                callback: function(value) { return value.toLocaleString(); }
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    }
                }
            });
        }

        function renderTable(data) {
            const tbody = document.getElementById('table-body');
            if (data.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="p-10 text-center text-gray-400">ì¡°íšŒëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td></tr>';
                return;
            }

            tbody.innerHTML = data.map(item => `
                <tr class="border-b border-gray-50 hover:bg-gray-50 transition-colors">
                    <td class="p-4 text-gray-500 whitespace-nowrap">${item["ê±°ë˜ì¼ì"]}</td>
                    <td class="p-4 font-semibold text-gray-800">${item["ì•„íŒŒíŠ¸ëª…"]}</td>
                    <td class="p-4 text-gray-600">${item["ë²•ì •ë™"]}</td>
                    <td class="p-4 text-gray-600">${item["ì „ìš©ë©´ì (ã¡)"]}ã¡</td>
                    <td class="p-4 text-gray-600">${item["ì¸µ"]}ì¸µ</td>
                    <td class="p-4 font-bold text-blue-600">${item.price.toLocaleString()}</td>
                </tr>
            `).join('');
        }

        function showError() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('error').classList.remove('hidden');
        }

        window.onload = init;
    </script>
</body>
</html>
